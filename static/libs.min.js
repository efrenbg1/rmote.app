window.addEventListener('popstate',function(event){if(event.state==undefined||event.state.session!==nav.session||document.getElementById('login').style.display=="block"){window.history.forward();return;}
nav.mainID=nav.section()[0];nav.main=nav.modules[nav.mainID];tools.animationTime=performance.now();$('#grid')[0].setAttribute('class','slide-out');setTimeout(function(){nav.reconstruct();},100);nav.order=event.state.order;nav.old=nav.section();nav.force=false;nav.title(event.state.title);document.title=event.state.nav;});class Navigation{constructor(){this.page=1;this.grid=document.getElementById("grid");this.old=[];this.order=0;this.session=Math.random();this.force=false;this.steps=0;this.modules={};this.mainID="control";}
section(){var location=window.location.pathname.substring(1).split("/");if(location[location.length-1]===""){location.pop();}
return location;}
reconstruct(){if(this.order===0){if(this.section().length===0){this.setSection(this.mainID);}else{this.setSection(this.section()[0]);}}
this.select(this.section()[0]);this.old=this.section();this.mainID=this.section()[0];this.main=this.modules[this.section()[0]];$('.modal').modal('hide');document.getElementById("grid").innerHTML="";this.main.class().list();}
select(id){var all=document.getElementsByClassName("active");while(all.length>0){all[0].classList.remove("active");}
var sel=document.getElementById(id);sel.classList.add("active");}
load(id){this.setSection(id);tools.animationTime=performance.now();$('#grid')[0].setAttribute('class','slide-out');setTimeout(function(){this.reconstruct();}.bind(this),100);if(document.getElementById("content").style.display==="none"){tools.hideNavbar();}}
setSection(section){this.order++;var url=window.location.origin+"/"+section;var icon=this.modules[section].icon;var name=this.modules[section].name;var title=`<li class="breadcrumb-item active" aria-current="page"><p class="mb-0"><i data-feather="{}"></i>&nbsp;{}</p></li>`.format(icon,name);history.pushState({prev:this.old,order:this.order,session:this.session,title:title,nav:"lemonSW - "+name},"",url);this.title(title);document.title="lemonSW - "+name;}
title(string){document.getElementById("title").innerHTML=string;try{feather.replace();}catch(e){console.log(e);}}}class Session{refresh(){try{tools.setCookie("Username",tools.getCookie("Username"),5);tools.setCookie("Session",tools.getCookie("Session"),5);}catch(e){}}
check(){if(tools.getCookie("Session")===undefined||tools.getCookie("Username")===undefined)return false;return true;}
showLogIn(icon,msg,type){$('.modal').modal('hide');var login_msg=document.getElementById("login_msg");login_msg.innerHTML=`<i data-feather="{}"></i>&nbsp;`.format(icon)+msg;login_msg.classList="text-center mb-2 text-"+type;$('#login').modal({backdrop:'static',keyboard:false});feather.replace();}
LogIn(){var user=document.getElementById("user").value;var pw=document.getElementById("pw").value;tools.showModal('logging');tools.req('/login',function(status,response){tools.hideModal('logging');if(status===200){tools.hideModal("login");tools.setCookie("Username",response['username'],5);tools.setCookie("Session",response['cookie'],5);nav.reconstruct();document.getElementById("user").value="";document.getElementById("pw").value="";window.removeEventListener('keydown',session.enter,false);}else if(status!=205){this.showLogIn("alert-triangle","Wrong e-mail/password ("+status+")","alert-danger");}}.bind(this),{'user':tools.encodeSTR(user),'pw':tools.encodeSTR(pw)});tools.hideLoading();}
LogOut(){tools.req('/logout',function(status,response){document.cookie="Username=;expires=Thu, 01 Jan 1970 00:00:01 GMT;";document.cookie="Session=;expires=Thu, 01 Jan 1970 00:00:01 GMT;";this.showLogIn("check","Session closed","success");}.bind(this));}
enter(e){if(e.keyCode===13){session.logIn();window.removeEventListener('keydown',session.enter,false);}}}class Toolbox{constructor(){this.socket=null;this.opened=false;this.callback=[];this.uReqTimer=null;this.setCookie('Content',version,43200);}
sOpen(){if(this.opened)return;this.opened=true;this.socket=io();this.socket.on('connect',function(){this.callback.forEach((n)=>{n();});this.callback=[];}.bind(this));this.socket.on('connect_error',function(err){tools.req('/check');this.sClose();}.bind(this));this.socket.on('disconnect',function(err){console.log(err)
this.sClose();}.bind(this));}
sClose(){try{this.socket.disconnect();}catch(e){}
this.opened=false;}
sreq(event,callback,headers){clearTimeout(this.uReqTimer);if(!session.check()){this.sClose();session.showLogIn('message-square','LogIn to continue','info');return;}
this.timeoutLoading();if(this.socket==null||this.socket.disconnected){this.callback.push(function(){tools.sreq(event,callback,headers);}.bind(this));this.sOpen();return;}
this.socket.emit(event,headers,function(response,status){this.hideLoading();if(typeof status!="number")status=200;callback(status,response);}.bind(this));}
screq(event,callback,headers){clearTimeout(this.uReqTimer);if(!session.check()){this.sClose();return;}
this.uReqTimer=setTimeout(function(){if(!session.check()){this.sClose();return;}
if(this.socket==null||this.socket.disconnected){this.callback.push(function(){tools.sreq(event,callback,headers);}.bind(this));this.sOpen();return;}
session.refresh();this.socket.emit(event,headers,function(response,status){if(typeof status!="number")status=200;callback(status,response);}.bind(this));}.bind(this),500);}
req(url,callback,headers){let req=new XMLHttpRequest();req.open('GET',url,true);if(headers!==undefined){let keys=Object.keys(headers);for(let i=0;i<keys.length;i++){req.setRequestHeader(keys[i],headers[keys[i]]);}}
req.responseType='json';req.onload=function(){if(req.status===401){tools.hideDiag();tools.showLogIn("Session timed out")}
if(callback!=undefined)callback(req.status,req.response);}.bind(this);req.send();}
controlledReq(url,callback,headers){if(this.uReq!==undefined){this.uReq.abort();}
this.uReq=new XMLHttpRequest();this.uReq.open('GET',url,true);if(headers!==undefined){let keys=Object.keys(headers);for(let i=0;i<keys.length;i++){this.uReq.setRequestHeader(keys[i],headers[keys[i]]);}}
this.uReq.responseType='json';this.uReq.onload=function(){callback(this.uReq.status,this.uReq.response);}.bind(this);this.uReq.send();}
alert(title,icon,type){$('#alertImg')[0].src="/img/405_{}.png".format(Math.floor(Math.random()*2)+1);var text=$('#alertText')[0];if(type==undefined){text.setAttribute("class",'mb-0 alert alert-danger');}else{text.setAttribute("class",'mb-0 alert alert-{}'.format(type));}
text.innerHTML=`<i data-feather="{}" class="rounded mr-1 inline-feather"></i>&nbsp;{}`.format(icon?icon:'alert-triangle',title);feather.replace();this.showModal('alert');}
showModal(name){$('#grid').removeAttr("class");$("#{}".format(name)).modal('show');}
hideModal(name){$("#"+name).modal("hide");}
showFailure(code){document.getElementById("toastContent").innerHTML=`<i data-feather="alert-triangle" class="rounded mr-1 inline-feather" color="red"></i>
            <strong class="mr-auto" style="color:red;">Error al ejecutar la acci√≥n&nbsp;({})</strong>`.format(code);$("#toast").toast({delay:6000});$("#toast").toast("show");feather.replace();}
showWarning(msg){document.getElementById("toastContent").innerHTML=`<i data-feather="info" class="rounded mr-1 inline-feather text-muted"></i>
            <strong class="mr-auto text-muted">{}</strong>`.format(msg);$("#toast").toast({delay:6000});$("#toast").toast("show");feather.replace();}
showSuccess(){document.getElementById("toastContent").innerHTML=`<i data-feather="check" class="rounded mr-1 inline-feather" color="green"></i>
            <strong class="mr-auto">Guardado correctamente</strong>`;$("#toast").toast({delay:6000});$("#toast").toast("show");feather.replace();}
showLoading(){$("#loading").modal({backdrop:"static",keyboard:false});}
timeoutLoading(){this.hideLoading();this.loading=window.setTimeout(function(){$("#loading").modal({backdrop:"static",keyboard:false});}.bind(this),500);}
hideLoading(){clearTimeout(this.loading);this.hideModal("loading");}
show(id){try{var object=document.getElementById(id);object.style.display='inline';object.style.visibility='visible';}catch(err){console.log("Can't find object by id: {}".format(id));}}
hide(id){try{var object=document.getElementById(id);object.style.display='none';}catch(err){console.log("Can't find object by id: {}".format(id));}}
draw(html,callback){var elapsed=performance.now()-this.animationTime;if(elapsed<100){setTimeout(function(){$('#grid')[0].innerHTML=html;if(callback!=undefined)callback();if(tools.animationCallback!=null)tools.animationCallback();tools.animationCallback=null;feather.replace();$('#grid')[0].setAttribute('class','slide-in');},100-elapsed);}else{$('#grid')[0].innerHTML=html;if(callback!=undefined)callback();if(tools.animationCallback!=null)tools.animationCallback();tools.animationCallback=null;feather.replace();$('#grid')[0].setAttribute('class','slide-in');}}
showNavbar(){this.hide("content");var navbar=document.getElementById("navbar");navbar.classList.remove("col-2");navbar.classList.add("col-6");this.show("navbar");this.show("blank");this.navbar=true;}
hideNavbar(){this.hide("navbar");this.hide("blank");var navbar=document.getElementById("navbar");navbar.classList.remove("col-6");navbar.classList.add("col-2");this.show("content");this.navbar=false;}
encodeSTR(string){return btoa(unescape(encodeURIComponent(string)));}
getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length===2)return parts.pop().split(";").shift();}
setCookie(name,data,minutes){if(minutes===0){document.cookie=name+"="+data+";";}else{var d=new Date();d.setTime(d.getTime()+(minutes*60*1000));document.cookie=name+"="+data+"; expires="+d.toUTCString();}}}
$(window).resize(function(){if($(window).width()>930){var navbar=$("#navbar")[0];var content=$("#content")[0];navbar.classList.remove("col-6");navbar.classList.add("col-2");content.classList.remove("col-12");content.classList.add("col-10");tools.show("navbar");tools.show("content");tools.hide("blank");}else{var navbar=$("#navbar")[0];var content=$("#content")[0];navbar.classList.remove("col-2");navbar.classList.add("col-6");content.classList.remove("col-10");content.classList.add("col-12");tools.hide("navbar");tools.show("content");tools.hide("blank");}});String.prototype.format=function(){var i=0,args=arguments;return this.replace(/{}/g,function(){return typeof args[i]!='undefined'?args[i++]:'';});};String.prototype.render=function(args){var reg="";Object.keys(args).forEach(n=>{reg+=(reg!=""?"|":"")+"{{"+n+"}}";});var re=new RegExp(reg,"gi");return this.replace(re,function(match){var str=args[match.substring(2,match.length-2)];return str!=null?str:"";});};