class Control{constructor(){this.templates=new controlTemplates();this.version=5;}
list(){tools.sreq('/control/list',function(status,response){if(status!==200){return;}
var cards="";response['own'].forEach((n)=>{n.update="";if(parseInt(n.version)!=this.version)n.update=this.templates.update;cards+=this.templates.card.render(n);});if(response['share'].length>0){var cards=cards+this.templates.divider.format('Shared');for(var i=0;i<response['share'].length;i++){var MAC=response['share'][i]['mac'];var name=response['share'][i]['name'];var update=this.templates.update;if(parseInt(response['share'][i]['version'])==this.version){update="";}
cards+=this.templates.card.render({update:update,name:name,MAC:MAC});}}
tools.draw(this.templates.grid.format(cards));this.updateCards(response['own']);}.bind(this));}
action(MAC,payload){session.refresh();tools.req('/control/action',function(status,response){if(status===200){tools.snack("Done")}else{tools.snack("Failed!")}}.bind(this),{'mac':MAC,'payload':payload});}
update(){tools.sreq('/control/update',function(status,response){if(status===200){this.updateCards(response);}else if(status===401){clearInterval(tools.interval);}else{tools.snack("No internet");}}.bind(this));}
updateCards(response){var status={null:'/img/papelito.png',"0":'/img/off.jpg',"1":'/img/on.jpg',"2":'/img/suspended.gif',"7":'/img/updating.gif',"8":'/img/recovery.jpg',"9":'/img/boardoff.png'};response.forEach((n)=>{document.getElementById(n.mac+"_status").src=status[n.status];var html=this.templates.waiting;switch(n.action){case'3':html=this.templates.turning;break;case'4':html=this.templates.turning;break;case'5':html=this.templates.failed;break;case'6':html=this.templates.done;break;case null:html=""
break;}
document.getElementById(n.mac+"_action").innerHTML=html});feather.replace();}}
class controlTemplates{constructor(){this.divider=`
<div class="mdl-cell mdl-cell--12-col">
<div class="hr-sect"><span class="mdl-layout-title">{}</span></div>
</div>
  `;this.update=`<button class="mdl-button mdl-js-button mdl-button--raised mdl-button mdl-js-ripple-effect"
                data-upgraded=",MaterialButton,MaterialRipple" style="display: inline; visibility: visible;">
            <i class="material-icons">system_update_alt</i> Update available
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>`;this.waiting=`<div class="alert alert-secondary text-center mb-0" role="alert">
            <i data-feather="check"></i>&nbsp;Waiting for command
        </div>`;this.turning=`<div class="alert alert-info text-center mb-0" role="alert">
        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>&nbsp;Working on it...
    </div>`;this.done=`<div class="alert alert-danger text-center mb-0" role="alert">
            <i data-feather="alert-triangle"></i>&nbsp;Action failed
        </div>`;this.dones=`<div class="alert alert-secondary text-center mb-0" role="alert" >
            <i data-feather="check"></i>&nbsp;Waiting for command
        </div>`;this.grid=`<div class="row d-flex justify-content-around">
        {}
        </div>
        `;this.card=`<div class="col-sm-4 pb-3">
	<div class="card">
		<img class="card-img-top mb-0" src="/img/off.jpg" id="{{mac}}_status">
		<div id="{{mac}}_action" class="mb-2"></div>
		<div class="card-body p-2">
			<h5 class="card-title text-center">{{name}}&nbsp;<small>({{mac}})</small></h5>
		</div>
		<div class="card-footer text-muted bg-white">
			<div class="container">
				<div class="row">
					<div class="col-4 px-0">
					</div>
					<div class="col-4 text-center px-0">
						<button type="button" class="btn btn-outline-danger">
							<i data-feather="power"></i>
						</button>
					</div>
					<div class="col-4 text-right px-0">
						<div class="btn-group dropup">
							<button type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
								aria-haspopup="true" aria-expanded="false">
								<i data-feather="chevron-up"></i>
							</button>
							<div class="dropdown-menu">
								<a class="dropdown-item pl-3 mb-1" href="javascript:"><i data-feather="download-cloud"></i>&nbsp;&nbsp;Update firmware</a>
								<a class="dropdown-item pl-3 mb-1" href="javascript:"><i data-feather="activity"></i>&nbsp;&nbsp;Recovery</a>
								<a class="dropdown-item pl-3" href="javascript:"><i data-feather="x-octagon"></i>&nbsp;&nbsp;Force off</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>`;}}
var control=new Control();nav.modules["control"]={class:function(){return control;},icon:"sliders",name:"Control center"};class Manager{constructor(){this.templates=new managerTemplates();}
list(){tools.sreq('/manager/list',function(status,response){if(status!=200){}
var own="";var share="";var html="";var boards=Object.keys(response['own']);this.total=response['own'].length+response['share'].length;response['own'].forEach((n)=>{own+=this.templates.card.render(n);});html+=this.templates.grid.format(own);response['share'].forEach((n)=>{share+=this.templates.shared.render(n);});if(response['share'].length>0){html+=this.templates.divider.format('Shared')+this.templates.grid.format(share);}
html+=this.templates.divider.format('New board')+this.templates.grid.format(this.templates.newCard);tools.draw(html);}.bind(this));}
add(){session.refresh();var mac=document.getElementById("new_MAC").value;var name=document.getElementById("new_Name").value;var filter=/^([a-zA-Z0-9]{1,10})$/;var re=/^(([A-Fa-f0-9]{2}[:]){5}[A-Fa-f0-9]{2}[,]?)+$/;if(filter.test(name)&&re.test(mac)){tools.sreq('/manager/change',function(status,response){if(status===200){tools.snack("Done");this.getCards();}else{tools.snack("Failed!")}
this.getCards();}.bind(this),{'mac':mac,'type':"8",'name':name});}else{tools.snack("Wrong input");}}
save(MAC){session.refresh();var name=document.getElementById(MAC+"_name");var cluster=(document.getElementById(MAC+"_cluster").checked)?'1':'0';var filter=/^([a-zA-Z0-9]{1,10})$/;if(!filter.test(name.value)){tools.show(MAC+"_characters");}else{tools.hide(MAC+"_characters");tools.req('/manager/change',function(status,response){if(status===200){tools.snack("Done");this.getCards();}else{tools.snack("Failed!")}}.bind(this),{'mac':MAC,'type':"0",'name':name.value,'cluster':cluster
});}}
checkShare(){var email=document.getElementById("email");var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(email.value.length>0){if(!filter.test(email.value)){tools.show("valid");tools.hide("save");}else{tools.hide("valid");tools.show("save");}}else{tools.show("save");tools.hide("valid");}}
share(MAC,old,email){session.refresh();if(email===undefined){showDialog({title:'Insert e-mail address of receiver (blank to disable it):',text:`<center><form action="javascript:">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <div class="popup">
            <span class="popuptext" id="valid">Please insert a valid email address or leave it blank to disable it</span></div>
            <input class="mdl-textfield__input" type="email" id="email" onkeyup="active.checkShare()" value="{}">
            <label class="mdl-textfield__label" for="sample1">Email:</label>
            </div>
            </form></center>`.format(old),positive:{title:'<h style="color:green;">Share</h>',id:'save',onClick:function(){active.share(MAC,old,true);}},negative:{title:'<h style="color:red;" disabled>Cancel</h>'},onLoaded:function(){tools.hide("save");}});}else{var email=document.getElementById("email").value;tools.hideDiag();tools.showLoading();tools.req('/manager/change',function(status,response){if(status===200){tools.snack("Done");this.getCards();}else{tools.hideDiag();tools.snack("Failed!");}}.bind(this),{"type":"1","email":tools.encodeSTR(email),"mac":MAC});}}
removeShare(MAC,force){session.refresh();if(force){tools.req('/manager/change',function(status,response){tools.hideDiag();if(status===200){tools.snack("Done");this.getCards();}else{tools.snack("Failed!");}}.bind(this),{"type":"1","email":"","mac":MAC});}else{if(this.total!==1||confirm("Removing the last board will delete this account! Are you sure?")){showDialog({title:`<h3 class="mdl-dialog__title" style="width:100%">Are you sure?</h3>`,text:`<br><center>Shared boards can't be added by user</center><br>`,negative:{title:'<h style="color:green;" disabled>No</h>',},positive:{title:'<h style="color:red;" disabled>Yes</h>',onClick:function(){active.removeShare(MAC,true);}},cancelable:true,contentStyle:{'max-width':'300px'},});}}}
remove(MAC,force){session.refresh();if(force){tools.req('/manager/change',function(status,response){tools.hideDiag();if(status===200){tools.snack("Done");this.getCards();}else{tools.snack("Failed!");}}.bind(this),{'mac':MAC,'type':"9"});}else{if(this.total!==1||confirm("Removing the last board will delete this account! Are you sure?")){showDialog({title:'<h3 class="mdl-dialog__title" style="width:100%">Are you sure?</h3>',text:'<br>',negative:{title:'<h style="color:green;" disabled>No</h>',},positive:{title:'<h style="color:red;" disabled>Yes</h>',onClick:function(){active.remove(MAC,true);}},cancelable:true,contentStyle:{'max-width':'300px'},});}}}}
class managerTemplates{constructor(){this.divider=`<div class="hr-sect text-muted mt-3 mb-2">
    <span>
        <h5>{}</h5>
    </span>
</div>`;this.grid=`<div class="row d-flex justify-content-around">
{}
</div>
`;this.card=`<div class="col-sm-4 pb-3">
	<div class="card">
		<img class="card-img-top mb-0" src="/img/on.jpg">
		<div class="card-body p-2 mt-2">
			<h5 class="card-title text-center">{{mac}}</h5>
		</div>
		<div class="card-body py-0 px-2">
			<div class="input-group mb-3">
				<div class="input-group-prepend">
					<span class="input-group-text">Name:</span>
				</div>
				<input type="text" class="form-control" placeholder="Board name" value="{{name}}">
			</div>
		</div>
		<div class="card-footer text-muted bg-white">
			<div class="container">
				<div class="row">
					<div class="col-4 text-left px-0">
						<button type="button" class="btn btn-outline-success" title="Save name">
							<i data-feather="save"></i>
						</button>
					</div>
					<div class="col-4 text-center px-0">
						<button type="button" class="btn btn-outline-primary" title="Share board">
							<i data-feather="share-2"></i>
						</button>
					</div>
					<div class="col-4 text-right px-0">
						<button type="button" class="btn btn-outline-danger" title="Remove board">
							<i data-feather="trash-2"></i>
						</button>
					</div>
					</>
				</div>
			</div>
		</div>
	</div>
</div>`;this.shared=`<div class="col-sm-4 pb-3">
<div class="card">
    <img class="card-img-top mb-0" src="/img/on.jpg">
    <div class="card-body p-2 mt-2">
        <h5 class="card-title text-center">{{mac}}</h5>
    </div>
    <div class="card-body py-0 px-2">
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">Name:</span>
            </div>
            <input type="text" class="form-control" placeholder="Board name" value="{{name}}" disabled>
        </div>
    </div>
    <div class="card-footer text-muted bg-white">
        <div class="container">
            <div class="row">
                <div class="col-4 px-0">
                </div>
                <div class="col-4 text-center px-0">
                    <button type="button" class="btn btn-outline-danger" title="Remove board">
                        <i data-feather="trash-2"></i>
                    </button>
                </div>
                <div class="col-4 px-0">
                </div>
            </div>
        </div>
    </div>
</div>
</div>`;this.newCard=`<div class="col-sm-4 pb-3">
<div class="card">
    <img class="card-img-top mb-0 mb-3" src="/img/on.jpg">
    <div class="card-body py-0 px-2">
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">MAC:</span>
            </div>
            <input type="text" class="form-control" placeholder="MAC address">
        </div>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">Name:</span>
            </div>
            <input type="text" class="form-control" placeholder="Board name">
        </div>
    </div>
    <div class="card-footer text-muted bg-white">
        <div class="container">
            <div class="row">
                <div class="col-4 px-0">
                </div>
                <div class="col-4 text-center px-0">
                    <button type="button" class="btn btn-outline-success" title="Add board">
                        <i data-feather="save"></i>
                    </button>
                </div>
                <div class="col-4 px-0">
                </div>
            </div>
        </div>
    </div>
</div>
</div>`;}}
var manager=new Manager();nav.modules["manager"]={class:function(){return manager;},icon:"edit",name:"Boards manager"};class Settings{constructor(){this.templates=new settingsTemplates();document.getElementById("grid").innerHTML=this.templates.grid;}
mail(){session.refresh();showDialog({title:'Change email:',text:`<center><form action="javascript:" autocomplete="off">
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <div class="popup">
            <span class="popuptext" id="valid">Please insert a valid email address</span></div>
            <input class="mdl-textfield__input" type="email" id="input-1" onkeyup="active.checkEmail()" autocomplete="false">
            <label class="mdl-textfield__label" for="sample1">New email</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield">
            <div class="popup">
            <span class="popuptext" id="match">Emails don´t match</span></div>
            <input class="mdl-textfield__input" type="email" id="input-2" onkeyup="active.checkEmail()">
            <label class="mdl-textfield__label" for="sample1">Repeat</label>
            </div>
            <div class="mdl-textfield mdl-js-textfield">
            <div class="popup">
            <span class="popuptext" id="pw">⮚ 8-20 characters<br>⮚ Contain only and at least one: uppercase, lowercase and number</span>
            </div>
            <input class="mdl-textfield__input" type="password" id="input-3" onkeyup="active.checkEmail()" autocomplete="new-password">
            <label class="mdl-textfield__label" for="input-3">Confirm password</label>
            </div>
            </form></center>`,positive:{title:'<h style="color:green;">Save</h>',id:'save',onClick:function(){active.updateEmail();}},negative:{title:'<h style="color:red;" disabled>Cancel</h>'},onLoaded:function(){tools.hide("save");}});}
password(){session.refresh();showDialog({title:'Change password:',text:`<center>
  <form action="javascript:" autocomplete="off">
    <div class="popup mdl-textfield mdl-js-textfield">
      <div class="popup">
        <span class="popuptext" id="popup1">⮚ 8-20 characters<br>⮚ Contain only and at least one: uppercase, lowercase and number</span>
      </div>
      <input class="mdl-textfield__input" type="password" id="input-1" onkeyup="active.checkPass()" autocomplete="new-password">
      <label id="input-1-text" class="mdl-textfield__label" for="sample1">Current password</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield">
      <div class="popup">
        <span class="popuptext" id="popup2">⮚ 8-20 characters<br>⮚ Contain only and at least one: uppercase, lowercase and number</span>
      </div>
      <div class="popup">
        <span class="popuptext" id="popup2_old">Can´t be the same as your older password</span></div>
      <input class="mdl-textfield__input" type="password" id="input-2" onkeyup="active.checkPass()" autocomplete="new-password">
      <label id="input-2-text" class="mdl-textfield__label" for="sample1">New password</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield">
      <div class="popup">
        <span class="popuptext" id="popup3">Passwords don´t match</span></div>
      <input class="mdl-textfield__input" type="password" id="input-3" onkeyup="active.checkPass()" autocomplete="new-password">
      <label id="input-3-text" class="mdl-textfield__label" for="sample1">Repeat</label>
    </div>
  </form>
</center>`,positive:{title:'<h style="color:green;">Save</h>',id:'save',onClick:function(){active.updatePassword();}},negative:{title:'<h style="color:red;" disabled>Cancel</h>'},onLoaded:function(){tools.hide("save");tools.hide("popup1");}});}
destroy(){session.refresh();showDialog({title:'Please confirm data to delete the account:',text:`<center>
  <form action="javascript:" autocomplete="off">
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
      <div class="popup">
        <span class="popuptext" id="popup2">Wrong email address</span></div>
      <input class="mdl-textfield__input" type="text" id="input-1" onkeyup="active.checkDestroy()" autocomplete="false">
      <label class="mdl-textfield__label" for="sample1">Email</label>
    </div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
      <div class="popup">
        <span class="popuptext" id="popup3">⮚ 8-20 characters<br>⮚ Contain only and at least one: uppercase, lowercase and number</span>
      </div>
      <input class="mdl-textfield__input" type="password" id="input-2" onkeyup="active.checkDestroy()" autocomplete="new-password">
      <label class="mdl-textfield__label" for="sample1">Password</label>
    </div>
  </form>
</center>`,positive:{title:'<h style="color:red;">Delete</h>',id:'delete',onClick:function(){active.destroyAccount();}},negative:{title:'<h style="color:green;" disabled>Cancel</h>'},onLoaded:function(){tools.hide("delete");}});}
updateEmail(){if(this.checkEmail()){var input_1=document.getElementById("input-1").value;var input_3=document.getElementById("input-3").value;tools.req('/settings/email',function(status,response){if(status===200){alert("E-mail has been changed! Reloading session...");session.logOut();}else{tools.snack("Something went wrong")}}.bind(this),{'new':tools.encodeSTR(input_1),'pw':tools.encodeSTR(input_3)});}}
updatePassword(){if(this.checkPass()){var input_1=document.getElementById("input-1").value;var input_2=document.getElementById("input-2").value;tools.req('/settings/password',function(status,response){if(status===200){alert("Password succesfully changed");}else{tools.snack("Something went wrong")}}.bind(this),{'pw':tools.encodeSTR(input_1),'new':tools.encodeSTR(input_2)});}}
destroyAccount(){if(this.checkDestroy()){var input_2=document.getElementById("input-2").value;tools.req('/settings/destroy',function(status,response){if(status===200){alert("Account succesfully deleted");session.logOut();}else{tools.snack("Something went wrong")}}.bind(this),{'pw':tools.encodeSTR(input_2)});}}
checkEmail(){var email=document.getElementById("input-1").value;var email2=document.getElementById("input-2").value;var pw=document.getElementById("input-3").value;var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;var filter2=/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])([a-zA-Z0-9]{8,20})$/;if(email){if(!filter.test(email)){tools.show("valid");tools.hide("match");tools.hide("pw");}else{tools.hide("valid");if(email==email2){if(!filter2.test(pw)){tools.show("pw");tools.hide("match");}else{tools.show("save");tools.hide("match");tools.hide("pw");return true;}}else{tools.show("match");tools.hide("pw");}}}else{tools.hide("match");tools.hide("valid");tools.hide("pw");}
return false;}
checkPass(){var input_1=document.getElementById("input-1");var input_2=document.getElementById("input-2");var input_3=document.getElementById("input-3");var input_1_text=document.getElementById("input-1-text");var input_2_text=document.getElementById("input-2-text");var input_3_text=document.getElementById("input-3-text");var filter=/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])([a-zA-Z0-9]{8,20})$/;if(input_1.value){if(!filter.test(input_1.value)){tools.show("popup1");tools.hide("save");tools.hide("popup3");tools.hide("popup2");tools.hide("popup2_old");}else{tools.hide("popup1");tools.hide("popup2_old");if(input_2.value){if(!filter.test(input_2.value)){tools.show("popup2");tools.hide("save");tools.hide("popup3");}else if(input_2.value==input_1.value){tools.hide("save");tools.hide("popup3");tools.hide("popup2");tools.show("popup2_old");}else{tools.hide("popup2");if(input_2.value==input_3.value){tools.show("save");tools.hide("popup3");return true;}else{tools.show("popup3");tools.hide("save");}}}else{tools.hide("save");tools.hide("popup2");}}}else{tools.hide("save");tools.hide("popup1");}
return false;}
checkDestroy(){var email=document.getElementById("input-1");var pw=document.getElementById("input-2");var filter_email=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;var filter_pw=/^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])([a-zA-Z0-9]{8,20})$/;if(tools.getCookie('Username')==""){session.logIn("Session expired");}
if(email.value){if(tools.getCookie('Username')!=email.value){tools.show("popup2");tools.hide("popup3");tools.hide("delete");}else if(tools.getCookie('Username')==email.value){tools.hide("popup2");tools.hide("delete");if(pw.value){if(!filter_pw.test(pw.value)){tools.show("popup3");}else{tools.show("delete");tools.hide("popup3");return true;}}}}else{tools.hide("popup2");tools.hide("popup3");tools.hide("delete");}
return false;}}
class settingsTemplates{constructor(){this.grid=`<div class="demo-cards mdl-cell mdl-cell--4-col mdl-cell--8-col-tablet mdl-grid mdl-grid--no-spacing">
    <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">

        <center>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty is-upgraded" data-upgraded=",MaterialTextfield">

                <button style="background-color: Transparent; background-repeat:no-repeat; border: none; cursor:pointer; outline:none;" onclick="active.mail();">
                    <i class="material-icons" style="position: center; transform:translateY(70%); font-size:70px;">email</i>
                </button>
            </div>
        </center>
    </div>
</div>

<div class="demo-cards mdl-cell mdl-cell--4-col mdl-cell--8-col-tablet mdl-grid mdl-grid--no-spacing">
    <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">

        <center>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty is-upgraded" data-upgraded=",MaterialTextfield">
                <button style="background-color: Transparent; background-repeat:no-repeat; border: none; cursor:pointer; outline:none;" onclick="active.password();">

                    <i class="material-icons" style="position: center; transform:translateY(70%); font-size:70px;">fingerprint</i>
                </button>
            </div>
        </center>
    </div>
</div>

<div class="demo-cards mdl-cell mdl-cell--4-col mdl-cell--8-col-tablet mdl-grid mdl-grid--no-spacing">
    <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">

        <center>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label is-dirty is-upgraded" data-upgraded=",MaterialTextfield">
                <button style="background-color: Transparent; background-repeat:no-repeat; border: none; cursor:pointer; outline:none;" onclick="active.destroy();">

                    <i class="material-icons" style="position: center; transform:translateY(70%); font-size:70px;">delete</i>
                </button>
            </div>
        </center>
    </div>
</div>

<div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
</div>`;}}